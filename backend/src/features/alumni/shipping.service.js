// Path: src/features/alumni/shipping.service.js
// ‡πÑ‡∏ü‡∏•‡πå: shipping.service.js - ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á

import Alumni from './alumni.model.js';
import { sendShippingNotificationEmail } from '../../utils/email.js';
import { createShippingNotification } from '../notification/notification.service.js';

/**
 * üöÄ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏¥‡∏©‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
 * ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà: ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå + ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
 */
export const getShippingList = async (filters = {}, options = {}) => {
  const {
    shippingStatus = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
    graduationYear,
    department,
    search,
    page = 1,
    limit = 20,
    sort = { createdAt: -1 }
  } = { ...filters, ...options };

  // Query ‡∏´‡∏•‡∏±‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  const query = {
    status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',  // ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    shippingStatus: shippingStatus  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
  };

  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  if (graduationYear) {
    query.graduationYear = graduationYear;
  }

  if (department) {
    query.department = department;
  }

  if (search && search.trim()) {
    query.$or = [
      { firstName: { $regex: search.trim(), $options: 'i' } },
      { lastName: { $regex: search.trim(), $options: 'i' } },
      { idCard: { $regex: search.trim(), $options: 'i' } },
      { trackingNumber: { $regex: search.trim(), $options: 'i' } }
    ];
  }

  const skip = (page - 1) * limit;

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const alumni = await Alumni.find(query)
    .populate('shippedBy', 'username')
    .populate('shippingHistory.updatedBy', 'username')
    .sort(sort)
    .skip(skip)
    .limit(limit);

  const total = await Alumni.countDocuments(query);

  return {
    data: alumni,
    total,
    page,
    limit,
    totalPages: Math.ceil(total / limit),
    summary: {
      readyToShip: await Alumni.countDocuments({
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        shippingStatus: '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'
      }),
      shipping: await Alumni.countDocuments({
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        shippingStatus: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'
      }),
      shipped: await Alumni.countDocuments({
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        shippingStatus: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'
      })
    }
  };
};

/**
 * üöÄ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
 */
export const updateShippingStatus = async (alumniId, shippingData, userId) => {
  const { 
    shippingStatus, 
    trackingNumber, 
    notes, 
    shippedDate 
  } = shippingData;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏®‡∏¥‡∏©‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const alumni = await Alumni.findById(alumniId);
  if (!alumni) {
    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏¥‡∏©‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤');
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (alumni.status !== '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  }

  if (alumni.deliveryOption !== '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå') {
    throw new Error('‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö tracking number ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  if (['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'].includes(shippingStatus) && !trackingNumber) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏');
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  const oldStatus = alumni.shippingStatus;

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  alumni.updateShippingStatus(shippingStatus, trackingNumber, notes, userId);

  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏≠‡∏á
  if (shippedDate && shippingStatus === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß') {
    alumni.shippedDate = new Date(shippedDate);
  }

  await alumni.save();

  console.log(`‚úÖ Shipping status updated: ${alumni.fullName} from "${oldStatus}" to "${shippingStatus}"`);

  // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
  if (oldStatus !== shippingStatus) {
    try {
      await sendShippingNotificationEmail(alumni, oldStatus, shippingStatus);
      console.log('‚úÖ Shipping notification email sent');
    } catch (error) {
      console.error('‚ùå Failed to send shipping notification email:', error);
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    try {
      await createShippingNotification(alumni, oldStatus, shippingStatus);
      console.log('‚úÖ System shipping notification created');
    } catch (error) {
      console.error('‚ùå Failed to create system shipping notification:', error);
    }
  }

  return alumni;
};

/**
 * üöÄ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (Bulk shipping)
 */
export const bulkUpdateShipping = async (alumniIds, shippingData, userId) => {
  const { shippingStatus, notes } = shippingData;
  
  if (!Array.isArray(alumniIds) || alumniIds.length === 0) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const alumni = await Alumni.find({
    _id: { $in: alumniIds },
    status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
    deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
  });

  if (alumni.length !== alumniIds.length) {
    throw new Error('‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ');
  }

  const results = [];
  const errors = [];

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
  for (const person of alumni) {
    try {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ tracking number
      person.updateShippingStatus(shippingStatus, null, notes, userId);
      await person.save();
      
      results.push({
        id: person._id,
        name: person.fullName,
        success: true
      });
    } catch (error) {
      errors.push({
        id: person._id,
        name: person.fullName,
        error: error.message
      });
    }
  }

  return {
    success: results,
    errors,
    total: alumniIds.length,
    updated: results.length,
    failed: errors.length
  };
};

/**
 * üöÄ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
 */
export const getShippingStatistics = async () => {
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const totalShippingMembers = await Alumni.countDocuments({
    deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
    status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
  });

  // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
  const shippingStatusCounts = await Alumni.aggregate([
    {
      $match: {
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
      }
    },
    {
      $group: {
        _id: '$shippingStatus',
        count: { $sum: 1 }
      }
    }
  ]);

  // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤
  const departmentShipping = await Alumni.aggregate([
    {
      $match: {
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
      }
    },
    {
      $group: {
        _id: {
          department: '$department',
          shippingStatus: '$shippingStatus'
        },
        count: { $sum: 1 }
      }
    },
    {
      $group: {
        _id: '$_id.department',
        statuses: {
          $push: {
            status: '$_id.shippingStatus',
            count: '$count'
          }
        },
        total: { $sum: '$count' }
      }
    }
  ]);

  // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const monthlyShipping = await Alumni.aggregate([
    {
      $match: {
        deliveryOption: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå',
        status: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        shippedDate: { $exists: true }
      }
    },
    {
      $group: {
        _id: {
          year: { $year: '$shippedDate' },
          month: { $month: '$shippedDate' }
        },
        count: { $sum: 1 }
      }
    },
    {
      $sort: { '_id.year': -1, '_id.month': -1 }
    }
  ]);

  return {
    totalShippingMembers,
    shippingStatusCounts,
    departmentShipping,
    monthlyShipping
  };
};

/**
 * üöÄ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
 */
export const trackShipment = async (trackingNumber) => {
  if (!trackingNumber || !trackingNumber.trim()) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏');
  }

  const alumni = await Alumni.findOne({ 
    trackingNumber: trackingNumber.trim() 
  })
  .populate('shippedBy', 'username')
  .populate('shippingHistory.updatedBy', 'username');

  if (!alumni) {
    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ');
  }

  return {
    alumni,
    trackingInfo: {
      trackingNumber: alumni.trackingNumber,
      shippingStatus: alumni.shippingStatus,
      shippedDate: alumni.shippedDate,
      shippedBy: alumni.shippedBy,
      deliveryNotes: alumni.deliveryNotes,
      shippingHistory: alumni.shippingHistory
    }
  };
};

export default {
  getShippingList,
  updateShippingStatus,
  bulkUpdateShipping,
  getShippingStatistics,
  trackShipment
};